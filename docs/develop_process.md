# Prism PoC 実装タスクチェックリスト

（2025/12/30 更新）
## 開発方針：ローカル環境を汚さない（テストはコンテナ内で完結）

本プロジェクトは Windows11 + Docker Desktop を前提とし、ローカルPCのPython環境（グローバル/venv）を汚さない方針とする。

- Python依存関係の導入・更新は backend コンテナ内でのみ行う
- テスト（pytest等）は backend コンテナ内でのみ実行する
- CI も「コンテナで実行するテスト手順」を基準に整備し、ローカル/CIで結果がズレないようにする

目的：
- 環境差分による不具合（依存関係・バージョン差異）を最小化する
- 参画者が増えても再現性の高い開発手順を維持する


## フェーズA：PoCを「操作可能」にする必須タスク

### A-0. 品質・土台（先に整備）

* [x] A-0-1. CORS を設定
    * [x] 例：`http://localhost:3001` を許可
    * [x] 許可オリジンは環境変数で切替できるようにする
* [x] A-0-2. テスト基盤を追加
    * [x] `pytest` / FastAPI TestClient
    * [x] カバレッジ計測（80%以上を維持）
    * [x] テストは backend コンテナ内で実行する（ローカルPCへpytest等を導入しない）

* [x] A-0-3. CI を追加
    * [x] Backend：テスト + coverage 80%以上
    * [x] Frontend：build を実行
* [x] A-0-4. Alembic 方針決定
    * [x] Alembic を導入し、起動時 `create_all` 依存を解消する方針を決める
    * [x] フェーズAでは「方針決定」まででも可（導入作業はフェーズBに寄せても良い）

#### A-0-4. Alembic 方針決定（決定事項）

- DBスキーマ管理は Alembic を正式採用する。
- フェーズAでは Alembic を導入せず、フェーズB-0で初期マイグレーションを作成する。
- フェーズB-0以降は Alembic を DB スキーマ管理の唯一の正とする。
- それに伴い、起動時の `Base.metadata.create_all(...)` は B-0 完了時に削除し、
  DB 作成・更新は `alembic upgrade head` に統一する。

---

### A-1. データセット一覧取得 API

* [x] `GET /datasets` エンドポイントを実装
* [x] `datasets` テーブルから一覧取得
* [x] 各 dataset について以下を返却

  * [x] dataset_id
  * [x] filename
  * [x] created_at
  * [x] 行数（`dataset_rows` の COUNT）
* [x] レスポンス形式を JSON として確定
* [x] Swagger（/docs）で確認
* [x] ユニットテストを追加（正常系：0件/複数件、行数COUNTが返ること）

---

### A-2. データセット詳細取得 API

* [x] `GET /datasets/{dataset_id}` を実装
* [x] 指定 dataset_id の存在チェック
* [x] 以下の情報を返却

  * [x] メタ情報（filename / created_at）
  * [x] 行数
  * [x] JSONB データのサンプル（先頭 N 行）
* [x] サンプル件数を固定値（例：10件）にする
* [x] エラー時のレスポンスを定義（404 等）
* [x] ユニットテストを追加（正常系、異常系：存在しないIDで404）

---

### A-3. フロントエンド：CSVアップロード機能

* [ ] CSVアップロード用画面を作成
* [ ] `<input type="file">` を配置
* [ ] `POST /datasets/upload` を呼び出す処理を実装
* [ ] 成功時レスポンス（dataset_id / 行数）を画面表示
* [ ] エラー時の最低限の表示（alert 等）
* [ ] ユニットテストを追加（少なくともAPI呼び出し処理を関数化してテスト）

---

## フェーズB：分析 PoC としての中核機能

### B-0. 品質・土台（分析機能の前に）

* [ ] Alembic を導入し、初期マイグレーションを作成（`datasets` / `dataset_rows`）
* [ ] 起動時の `create_all` を削除（DBスキーマはマイグレーションで管理）
* [ ] CI にマイグレーション適用（例：テストDBに `alembic upgrade head`）を組み込む

---

### B-1. 最小集計（統計）API

* [ ] `GET /datasets/{dataset_id}/stats` を実装
* [ ] 対象 dataset の行数を算出
* [ ] JSONB からカラム一覧を抽出
* [ ] 数値カラムについて以下を算出（可能な範囲で）

  * [ ] min
  * [ ] max
  * [ ] avg
* [ ] 集計結果を JSON で返却
* [ ] 計算不可カラムは除外（PoC割り切り）
* [ ] ユニットテストを追加（数値/非数値/欠損の混在を含む最低限のパターン）

---

### B-2. LLM 簡易分析 API

* [ ] 集計結果（B-1）を入力とする処理を実装
* [ ] LLM 用プロンプトをコード内に定義
* [ ] 「注目点 / 仮説」をテキスト生成
* [ ] `GET /datasets/{dataset_id}/analysis` 等で提供
* [ ] 出力は保存せず都度生成（PoC割り切り）
* [ ] ユニットテストを追加（LLM呼び出しはスタブ/モックし、プロンプト組み立てとレスポンス整形を検証）

---

## フェーズC：管理画面として最低限成立させる

### C-0. 品質・土台（画面機能の前に）

* [ ] フロントのCIを整備（`npm ci` → `npm run build`）
* [ ] フロントの簡易テスト導入（最低限のレンダリング/ロジックのテスト。テスト方式はここで確定）

---

### C-1. データセット一覧画面

* [ ] 起動時に `GET /datasets` を呼び出す
* [ ] データセット一覧をテーブル表示
* [ ] dataset_id をクリック可能にする
* [ ] 選択時に詳細画面へ遷移
* [ ] ユニットテストを追加（一覧表示・エラー表示の最低限）

---

### C-2. データセット詳細・分析画面

* [ ] 詳細 API（A-2）の結果を表示
* [ ] 集計 API（B-1）の結果を表示
* [ ] LLM 分析結果（B-2）を表示
* [ ] レイアウトは最小限（装飾不要）
* [ ] ユニットテストを追加（詳細取得失敗時の表示、主要コンポーネントが落ちないこと）

---

### C-3. 簡易グラフ表示（任意）

* [ ] グラフライブラリを 1 つ選定
* [ ] 件数 or 数値分布を 1 種類表示
* [ ] 見た目より「動くこと」を優先

---

## フェーズD：安定性・PoC品質の底上げ（後回し可）

* [ ] CSV の文字コードエラー対策（UTF-8前提明示）
* [ ] 空 CSV / 不正 CSV のエラーハンドリング
* [ ] Backend ログの粒度整理
* [ ] README に「PoCでやらないこと」を再明示

---

## PoC完了チェック（Done 定義との照合）

* [ ] CSV をブラウザからアップロードできる
* [ ] PostgreSQL にデータが格納される
* [ ] 集計結果を API で取得できる
* [ ] LLM の分析コメントが生成される
* [ ] すべてを画面上で確認できる

---