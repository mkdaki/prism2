# プロンプト設計ドキュメント

> LLM（Gemini）に送信するプロンプトの設計思想と変遷を記録する

**最終更新**: 2026-01-18
**対象タスク**: E-2-2-1-3

---

## 概要

Prismの比較分析機能では、2つのデータセットの差分をLLMに分析させ、ビジネス的な示唆を生成する。プロンプトのバージョンは `?version=v1` または `?version=v2` で切り替え可能。

```
GET /datasets/compare/analysis?base=4&target=9&version=v2
```

---

## v1: 統計差分重視（非推奨）

### 設計思想
- データセット間の統計的差分をそのままLLMに渡す
- 数値変化（行数、列ごとの平均/最小/最大）を中心に分析

### 問題点
1. **無意味な指標を分析**: No, Page, rowOrderなどの技術的メタデータを主要な分析対象にしてしまう
2. **ビジネス価値ゼロ**: 「rowOrderの平均値が7.5減」などの考察は依頼者にとって無価値
3. **アクション不在**: 具体的な推奨行動が提示されない
4. **読み手不在**: 誰に向けた分析か不明確

### 出力例（v1）
```
## 変化の概要
- rowOrderの平均値が9.7%減少していることから、データの並び順やグルーピングに変化が生じた可能性があります。
- Pageの平均値もわずかに減少しており、ページ構成に何らかの変更があった可能性が考えられます。
```

---

## v2: ビジネス文脈重視（推奨）

### 設計思想
1. **読み手を明確化**: フリーランスエンジニア市場のビジネスアナリストとしてのロール設定
2. **ビジネス指標を優先**: 価格帯の変化、キーワードトレンドを最優先で入力
3. **アクション指向**: 「次に何をすべきか」を必ず提案させる
4. **根拠の明確化**: データに基づく分析と推測を区別させる
5. **技術指標を排除**: No, Page, rowOrderなどの無意味な指標は入力しない

### 入力データの優先順位
1. 価格帯の変化（高/中/低単価の増減）
2. 案件内容のキーワード変化（増加/減少Top5、新規/消失）
3. 行数変化（参考情報として最後）

### 出力フォーマット（5セクション）
```
## ビジネス動向サマリー
[1-2文で全体像]

## 価格動向
[高/中/低単価の変化と示唆]

## 案件内容のトレンド
[キーワードの増減から技術トレンドを分析]

## 推奨アクション
[具体的な次のアクション3-5つ]

## 前提・限界
[分析の前提条件、注意点]
```

### 出力例（v2）
```
## ビジネス動向サマリー
フリーランスエンジニア市場は、高単価案件が大幅に減少し、低単価案件が増加傾向にあるため、
全体的に価格競争が激化している可能性がある。

## 価格動向
- 高単価案件の増減とその意味: 80万円以上の高単価案件が64.3%減と大幅に減少している。
  これは、企業側のコスト削減志向の高まりを示唆する。

## 推奨アクション
- スキル強化の優先順位:
  1. AWSなどのクラウド技術
  2. TypeScriptなどのフロントエンド技術
  3. Java, VBAなどの既存技術
```

---

## v1 vs v2 比較表

| 観点 | v1 | v2 |
|------|----|----|
| 主な入力 | 統計差分（全列） | 価格帯・キーワード変化 |
| 技術指標 | 含む（No, Page等） | 排除 |
| ビジネス示唆 | なし | あり |
| アクション提案 | なし | 3-5項目 |
| 読み手 | 不明確 | フリーランスエンジニア |
| 文字数 | 約500-800文字 | 約1500-2000文字 |

---

## 今後の拡張予定

v2は以下のタスクで拡張予定:

- **E-2-2-1-4**: スキル需要の変化セクション追加
- **E-2-2-1-5**: カテゴリ別動向セクション追加

拡張後は7セクション構成になる予定。

---

## API使用方法

```bash
# v1（非推奨）
curl "http://localhost:8001/datasets/compare/analysis?base=4&target=9&version=v1"

# v2（推奨）
curl "http://localhost:8001/datasets/compare/analysis?base=4&target=9&version=v2"

# デフォルトはv1（後方互換性のため）
curl "http://localhost:8001/datasets/compare/analysis?base=4&target=9"
```

Swagger UIでも確認可能: `http://localhost:8001/docs`
