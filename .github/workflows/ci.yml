name: ci

on:
  push:
    branches:
      - main
      - develop
  pull_request:
  workflow_dispatch:

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    env:
      POSTGRES_DB: prism
      POSTGRES_USER: prism
      POSTGRES_PASSWORD: prism_password
      COMPOSE_PROJECT_NAME: prism2-ci
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Docker versions
        run: |
          docker --version
          docker compose version

      - name: Build backend image
        run: docker compose build backend

      - name: Start database
        run: docker compose up -d db

      - name: Wait for database ready
        shell: bash
        run: |
          set -euo pipefail
          for i in {1..60}; do
            if docker compose exec -T db pg_isready -U "${POSTGRES_USER}" -d "${POSTGRES_DB}" >/dev/null 2>&1; then
              echo "db is ready"
              exit 0
            fi
            sleep 1
          done
          echo "db was not ready in time"
          docker compose logs db
          exit 1

      - name: Run alembic upgrade head (explicit)
        run: docker compose run --rm -e RUN_MIGRATIONS=0 backend alembic upgrade head

      - name: Run pytest (in backend container) with coverage gate
        run: docker compose run --rm -e RUN_MIGRATIONS=0 backend pytest

      - name: Cleanup
        if: always()
        run: docker compose down -v

  frontend-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build
        working-directory: frontend
        run: npm run build


